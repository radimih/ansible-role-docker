---
- name: Установить службу crond на RedHat-семействе ОС
  block:

    - name: Установить пакет cronie
      ansible.builtin.dnf:
        name: cronie

    - name: Запустить службу crond
      ansible.builtin.systemd:
        name: crond
        state: started
        enabled: true

  when: ansible_os_family | lower == 'redhat'
  become: true

- name: Настроить ежедневную очистку Docker
  ansible.builtin.copy:
    content: |
      #!/bin/sh
      #
      # Чистка от неиспользуемых Docker-контейнеров, сетей, образов и томов (volumes)
      #

      if [ -x /usr/bin/docker ]; then
          /usr/bin/docker container prune --force --filter "until={{ containers_older_hours }}h"
          /usr/bin/docker network   prune --force --filter "until={{ containers_older_hours }}h"
          /usr/bin/docker image     prune --force --filter "until={{ images_older_hours }}h" -all
          /usr/bin/docker volume    prune --force
      fi
    dest: /etc/cron.daily/docker-prune.sh
    mode: 0755
  become: true
